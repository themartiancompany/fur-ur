---

# SPDX-License-Identifier: AGPL-3.0

#
#    .gitlab-ci.yaml
#
#    ----------------------------------------------------------------------
#    Copyright Â© 2022, 2023, 2024, 2025
#                Pellegrino Prevete
#
#    All rights reserved
#    ----------------------------------------------------------------------
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.


default:
  image: archlinux:latest

stages:
  - build
  - release

.build:
  artifacts:
    paths:
      - dogeos-gnu-*.pkg.tar.*
    reports:
      metrics: output/metrics.txt
      dotenv: /build.env
  before_script:
    - >
      pacman \
        -Sy \
        --needed \
        --noconfirm \
          archlinux-keyring
    
    - >  
      pacman \
        -Su \
        --needed \
        --noconfirm \
          bash \
          git \
          jq \
          python-docutils

    # Extra packages dependencies
    # archiso-encryption-git
    - >
      pacman \
        -Su \
        --needed \
        --noconfirm \
          asciidoctor \
          fakeroot \
          gnupg \
          make \
          shellcheck \
          shfmt

    # Save gl-dl private token in the
    # container
    - >
      mkdir \
        -p \
        "/root/.config/gitlab.com"
      echo \
        "${GL_DL_PRIVATE_TOKEN}" > \
        "/root/.config/gitlab.com/default.txt"
      echo \
        "${BUR_GPG_KEY}" | \
        base64 \
          -d > \
        "/root/bur.asc"
      gpg \
        --import \
          "/root/bur.asc" || \
        true

    # Setup user
    - >
      useradd \
        "user"
      mkdir \
        -p \
        "/home/user"
      chmod \
        700 \
        "/home/user"
      cp \
        -r \
        "/builds/themartiancompany/${CI_PROJECT_NAME}" \
        "/home/user/${CI_PROJECT_NAME%-ur}"
      chown \
        -R \
        "user:user" \
        "/home/user"

    # Save variables for next stage
    - >
      echo \
        "GL_DL_PRIVATE_TOKEN='${GL_DL_PRIVATE_TOKEN}'" >> \
        "/build.env"
       echo \
         "BUR_GPG_KEY='${BUR_GPG_KEY}'" >> \
         "/build.env"

  script:
    - ./.gitlab/ci/build.sh ${BUILD_SCRIPT_ARGS}
  stage: build

.release:
  artifacts:
    paths:
      - dogeos-gnu-*.pkg.tar.*
    reports:
      metrics: output/metrics.txt
      dotenv: /build.env
  before_script:
    - >
      pacman \
        -Sy \
        --needed \
        --noconfirm \
          archlinux-keyring
    - >  
      pacman \
        -Su \
        --needed \
        --noconfirm \
          bash \
          git \
          jq \
          python-docutils

    # Extra packages dependencies
    # archiso-encryption-git
    - >
      pacman \
        -Su \
        --needed \
        --noconfirm \
          asciidoctor \
          fakeroot \
          gnupg \
          make \
          shellcheck \
          shfmt

    # Save gl-dl private token in the
    # container
    - >
      mkdir \
        -p \
        "/root/.config/gitlab.com"
      if [[ "${GL_DL_PRIVATE_TOKEN}" == "" ]] ; then
        _msg=(
         "Variable 'GL_DL_PRIVATE_TOKEN' empty."
        )
        echo \
          ${_msg[*]}"
        exit \
          1
      elif [[ "${GL_DL_PRIVATE_TOKEN}" != "" ]] ; then
        echo \
          "${GL_DL_PRIVATE_TOKEN}" > \
          "/root/.config/gitlab.com/default.txt"
      fi
      if [[ "${BUR_GPG_KEY}" == "" ]] ; then
        _msg=(
         "Variable 'BUR_GPG_KEY' empty."
        )
        echo \
          ${_msg[*]}"
        exit \
          1
      elif [[ "${BUR_GPG_KEY}" != "" ]] ; then
        echo \
          "${BUR_GPG_KEY}" | \
          base64 \
            -d > \
          "/root/bur.asc"
        gpg \
          --import \
            "/root/bur.asc" || \
          true
      fi

    # Setup user
    - >
      useradd \
        "user"
      mkdir \
        -p \
        "/home/user"
      chmod \
        700 \
        "/home/user"
      cp \
        -r \
        "/builds/themartiancompany/${CI_PROJECT_NAME}" \
        "/home/user/${CI_PROJECT_NAME%-ur}"
      chown \
        -R \
        "user:user" \
        "/home/user"
  script:
    - ./.gitlab/ci/build.sh ${BUILD_SCRIPT_ARGS}
  stage: release

build:
  extends: .build
  parallel:
    matrix:
      - BUILD_SCRIPT_ARGS: arch x86_64 ${CI_PROJECT_NAMESPACE} ${CI_PROJECT_NAME} ${CI_COMMIT_SHA}
  only:
    refs:
      - master
      - merge_requests
    changes:
      - PKGBUILD
      - README.md
      - COPYING
      - .gitlab-ci.yml
      - .gitlab/ci/*
  interruptible: true

release:
  extends: .build
  parallel:
    matrix:
      - BUILD_SCRIPT_ARGS: arch x86_64 ${CI_PROJECT_NAMESPACE} ${CI_PROJECT_NAME} ${CI_COMMIT_SHA}
  rules:
    - if:
        $CI_COMMIT_TAG
  release:
    tag_name: $CI_COMMIT_TAG
    description: $CI_COMMIT_TAG
  interruptible: true
